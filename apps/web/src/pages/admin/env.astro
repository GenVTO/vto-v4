---
import AdminLayout from '../../layouts/AdminLayout.astro'

interface RuntimeLocals {
  runtime?: {
    env?: Record<string, unknown>
  }
}

function readString(value: unknown): string | null {
  return typeof value === 'string' ? value : null
}

function maskSecret(value: string | null): string | null {
  if (!value) {
    return value
  }

  if (value.length <= 8) {
    return '***'
  }

  return `${value.slice(0, 4)}...${value.slice(-4)}`
}

function readJsonArray(value: string | null): Record<string, unknown>[] {
  if (!value) {
    return []
  }

  try {
    const parsed = JSON.parse(value) as unknown
    return Array.isArray(parsed) ? (parsed as Record<string, unknown>[]) : []
  } catch {
    return []
  }
}

const runtimeEnv = (Astro.locals as RuntimeLocals).runtime?.env ?? {}
const nodeEnv = readString(runtimeEnv.NODE_ENV) ?? 'development'

const r2Configs = readJsonArray(readString(runtimeEnv.R2_CONFIGS_JSON))
const debug = {
  fashn: {
    base_url: readString(runtimeEnv.FASHN_BASE_URL),
    has_api_key: Boolean(readString(runtimeEnv.FASHN_API_KEY)),
  },
  logger: {
    axiom_dataset: readString(runtimeEnv.AXIOM_DATASET),
    has_axiom_token: Boolean(readString(runtimeEnv.AXIOM_TOKEN)),
    has_sentry_dsn: Boolean(readString(runtimeEnv.SENTRY_DSN)),
    log_enable_axiom: readString(runtimeEnv.LOG_ENABLE_AXIOM),
    log_enable_pino: readString(runtimeEnv.LOG_ENABLE_PINO),
    log_enable_sentry: readString(runtimeEnv.LOG_ENABLE_SENTRY),
    log_level: readString(runtimeEnv.LOG_LEVEL),
    sentry_dsn_preview: maskSecret(readString(runtimeEnv.SENTRY_DSN)),
  },
  mode: nodeEnv,
  r2: {
    configs_json: readString(runtimeEnv.R2_CONFIGS_JSON),
    configs_runtime_bindings: r2Configs.map((config) => {
      const binding = readString(config.binding)
      return {
        binding,
        has_binding_object: Boolean(binding && runtimeEnv[binding]),
        name: readString(config.name),
      }
    }),
    order: readString(runtimeEnv.STORAGE_PROVIDER_ORDER),
  },
  supabase: {
    has_service_role_key: Boolean(
      readString(runtimeEnv.SUPABASE_SERVICE_ROLE_KEY),
    ),
    url: readString(runtimeEnv.SUPABASE_URL),
  },
}
---

<AdminLayout title="Dev Env Inspector">
  <div class="mb-8">
    <h1 class="text-3xl font-bold tracking-tight">Environment Variables</h1>
    <p class="mt-2 text-slate-500">
      Current runtime configuration debug information.
    </p>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-slate-50">
    <div class="border-b border-slate-200 bg-white px-4 py-3">
      <h3 class="font-mono text-sm font-semibold text-slate-900">
        Runtime Config
      </h3>
    </div>
    <pre
      class="overflow-x-auto p-4 text-xs text-slate-700">
      {JSON.stringify(debug, null, 2)}
    </pre>
  </div>
</AdminLayout>
